<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</title>
  <style>
    :root {
      --wa-green: #075e54;
      --wa-green-light: #128c7e;
      --wa-teal: #25d366;
      --wa-chat-bg: #e6ddd4;
      --wa-message-sent: #dcf8c6;
      --wa-message-received: #ffffff;
      --wa-text-dark: #303030;
      --wa-text-light: #757575;
      --wa-border: #e0e0e0;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background: var(--wa-chat-bg);
      height: 100vh;
      overflow: hidden;
      color: var(--wa-text-dark);
      line-height: 1.4;
    }

    /* Ø§Ù„Ù‡ÙŠØ¯Ø± ÙŠØ´Ø¨Ù‡ ÙˆØ§ØªØ³Ø§Ø¨ */
    .header {
      background: var(--wa-green);
      color: white;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 15px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      height: 60px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .back-btn {
      color: white;
      text-decoration: none;
      font-size: 20px;
      display: flex;
      align-items: center;
    }

    .chat-info {
      flex: 1;
    }

    .chat-title {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .chat-status {
      font-size: 13px;
      opacity: 0.9;
    }

    .header-actions {
      display: flex;
      gap: 20px;
      color: white;
    }

    .header-icon {
      font-size: 20px;
      cursor: pointer;
    }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    .messages-container {
      padding: 70px 0 80px 0;
      height: 100vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .message {
      display: flex;
      margin-bottom: 8px;
      padding: 0 16px;
      animation: messageSlide 0.3s ease-out;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.received {
      justify-content: flex-start;
    }

    .message.sent {
      justify-content: flex-end;
    }

    .message-bubble {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 7.5px;
      position: relative;
      word-wrap: break-word;
    }

    .message.received .message-bubble {
      background: var(--wa-message-received);
      border-top-left-radius: 0;
      box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
    }

    .message.sent .message-bubble {
      background: var(--wa-message-sent);
      border-top-right-radius: 0;
      box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
    }

    .message-text {
      font-size: 14.2px;
      line-height: 19px;
      color: var(--wa-text-dark);
      margin-bottom: 4px;
    }

    .message-time {
      font-size: 11px;
      color: var(--wa-text-light);
      text-align: left;
      float: right;
      margin-left: 8px;
      margin-top: 2px;
    }

    .message.sent .message-time {
      color: var(--wa-green-light);
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
    .input-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #f0f0f0;
      padding: 8px 16px;
      border-top: 1px solid var(--wa-border);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .input-wrapper {
      flex: 1;
      background: white;
      border-radius: 20px;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .input-icon {
      color: var(--wa-text-light);
      font-size: 20px;
      cursor: pointer;
    }

    #messageInput {
      flex: 1;
      border: none;
      outline: none;
      font-size: 15px;
      background: transparent;
      font-family: inherit;
    }

    #messageInput::placeholder {
      color: var(--wa-text-light);
    }

    .send-btn {
      background: var(--wa-green);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .send-btn:active {
      background: var(--wa-green-light);
      transform: scale(0.95);
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
    .messages-container::-webkit-scrollbar {
      width: 4px;
    }

    .messages-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .messages-container::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.2);
      border-radius: 2px;
    }

    /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ù„Ù…Ø³ */
    .touch-effect:active {
      opacity: 0.7;
    }

    /* ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨ */
    @media (max-width: 480px) {
      .message-bubble {
        max-width: 80%;
      }
      
      .header {
        padding: 12px;
      }
      
      .input-container {
        padding: 8px 12px;
      }
    }

    /* Ø®Ù„ÙÙŠØ© ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ù…ÙŠØ²Ø© */
    .messages-container {
      background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23075e54' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
    }

    /* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨ */
    .emoji-icon::after { content: '.'; }
    .attach-icon::after { content: '.'; }
    .mic-icon::after { content: '.'; }
    .camera-icon::after { content: '.'; }
    .menu-icon::after { content: 'â‹®'; }

    /* Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ */
    .welcome-message {
      text-align: center;
      padding: 20px;
      color: var(--wa-text-light);
      font-size: 14px;
      background: rgba(255,255,255,0.8);
      margin: 10px 16px;
      border-radius: 8px;
      border: 1px solid var(--wa-border);
    }
  </style>
</head>
<body>
  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <div class="header">
    <a href="/profile" class="back-btn touch-effect">â€¹</a>
    <div class="chat-info">
      <div class="chat-title">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</div>
      <div class="chat-status"><%= messages.length %> Ø£Ø¹Ø¶Ø§Ø¡ Ù…ØªØµÙ„ÙˆÙ†</div>
    </div>
    <div class="header-actions">
      <div class="header-icon touch-effect camera-icon"></div>
      <div class="header-icon touch-effect menu-icon"></div>
    </div>
  </div>

  <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
  <div class="messages-container" id="messagesContainer">
    <% if (messages.length === 0) { %>
      <div class="welcome-message">
        ğŸ’¬ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©<br>
        Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©...
      </div>
    <% } %>

    <% messages.forEach(msg => { %>
      <div class="message <%= msg.userId.toString() === userId ? 'sent' : 'received' %>">
        <div class="message-bubble">
          <% if (msg.userId.toString() !== userId) { %>
            <div style="font-size: 12px; color: var(--wa-green); margin-bottom: 4px; font-weight: 500;">
              <%= msg.username %>
            </div>
          <% } %>
          <div class="message-text"><%= msg.text %></div>
          <div class="message-time">
            <%= new Date(msg.createdAt).toLocaleTimeString('ar-SA', { 
              hour: '2-digit', 
              minute: '2-digit' 
            }) %>
          </div>
        </div>
      </div>
    <% }) %>
  </div>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
  <div class="input-container">
    <div class="input-icon touch-effect emoji-icon"></div>
    <div class="input-icon touch-effect attach-icon"></div>
    <div class="input-wrapper">
      <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." autocomplete="off">
      <div class="input-icon touch-effect mic-icon"></div>
    </div>
    <button class="send-btn touch-effect" id="sendBtn">
      â¤
    </button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', function() {
      // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      const userId = '<%= userId %>';
      if (userId) {
        localStorage.setItem('userId', userId);
      }

      // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„
      scrollToBottom();
      
      // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
      setTimeout(() => {
        document.getElementById('messageInput').focus();
      }, 300);
    });

    // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„
    function scrollToBottom() {
      const container = document.getElementById('messagesContainer');
      container.scrollTop = container.scrollHeight;
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Socket.IO
    const socket = io();
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const messagesContainer = document.getElementById('messagesContainer');

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    function sendMessage() {
      const messageText = messageInput.value.trim();
      
      if (messageText) {
        // ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        sendBtn.style.transform = 'scale(0.9)';
        setTimeout(() => {
          sendBtn.style.transform = 'scale(1)';
        }, 150);

        socket.emit('chat message', { text: messageText });
        messageInput.value = '';
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ÙƒÙŠØ²
        setTimeout(() => messageInput.focus(), 100);
      }
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø²Ø±
    sendBtn.addEventListener('click', sendMessage);

    // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±
    messageInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    socket.on('chat message', function(msg) {
      const messageDiv = document.createElement('div');
      const isSent = msg.userId === '<%= userId %>';
      
      messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
      
      const timeString = new Date(msg.createdAt || new Date()).toLocaleTimeString('ar-SA', {
        hour: '2-digit',
        minute: '2-digit'
      });

      messageDiv.innerHTML = `
        <div class="message-bubble">
          ${!isSent ? `<div style="font-size: 12px; color: var(--wa-green); margin-bottom: 4px; font-weight: 500;">${msg.username}</div>` : ''}
          <div class="message-text">${msg.text}</div>
          <div class="message-time">${timeString}</div>
        </div>
      `;
      
      messagesContainer.appendChild(messageDiv);
      scrollToBottom();

      // ØªØ£Ø«ÙŠØ± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      if (!isSent && 'vibrate' in navigator) {
        navigator.vibrate(50);
      }
    });

    // Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    socket.on('connect', function() {
      console.log('âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©');
    });

    socket.on('disconnect', function() {
      console.log('âŒ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„');
    });

    // ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
    let isKeyboardOpen = false;
    
    window.addEventListener('resize', function() {
      const newState = window.innerHeight < document.documentElement.clientHeight;
      
      if (newState !== isKeyboardOpen) {
        isKeyboardOpen = newState;
        if (isKeyboardOpen) {
          setTimeout(scrollToBottom, 300);
        }
      }
    });

    // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
  </script>
</body>
</html>